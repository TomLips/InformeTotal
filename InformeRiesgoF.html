<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe de Riesgo vs Optimismo de Mercado</title>
    <style>
        body {
            font-family: sans-serif;
            background: #f4f4f4;
            margin: 0;
            padding: 15px;
        }
        h2 {
            text-align: center;
            font-size: 1.8rem;
            letter-spacing: 1px;
            margin-top: 15px;
            margin-bottom: 0;
            color: #222;
        }
        .subtitulo {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
            margin-top: 5px;
        }
        .espacio-linea {
            height: 10px;
        }
        .container {
            background: #fff;
            padding: 0 0 20px 0;
            border-radius: 12px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
            margin: 15px auto;
            width: 100%;
            max-width: 900px;
            box-sizing: border-box;
        }
        .antigua, .actual, .riesgo-global {
            box-sizing: border-box;
            width: 100%;
            padding-left: 15px;
            padding-right: 15px;
        }
        .antigua {
            background: #f9f9f9;
            padding-top: 20px;
            padding-bottom: 15px;
            border-radius: 12px 12px 0 0;
        }
        .contexto {
            font-size: 1.1rem;
            color: #555;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
        }
        .actual {
            background: #e8eaed;
            padding-top: 15px;
            padding-bottom: 20px;
        }
        .riesgo-global {
            background: #d6d8dc;
            padding-top: 15px;
            padding-bottom: 20px;
            border-radius: 0 0 12px 12px;
            margin-bottom: 0;
        }
        .mini-section {
            font-size: 1.0rem;
            color: #555;
            margin-bottom: 6px;
        }
        .media-section {
            font-size: 1.0rem;
            color: #666;
            margin-bottom: 6px;
            font-weight: 500;
        }
        .mini-barra, .final-barra, .global-barra {
            width: 100%;
            margin: 0 auto 12px auto;
            position: relative;
            box-sizing: border-box;
            display: block;
        }
        .mini-barra {
            height: 12px;
            background: #e9e9e9;
            border-radius: 6px;
        }
        .final-barra {
            height: 24px;
            background: #f1f3f7;
            border-radius: 12px;
            margin-bottom: 18px;
            box-shadow: 0 1px 6px rgba(0,0,0,0.05);
        }
        .global-barra {
            height: 24px;
            background: #e2e4e7;
            border-radius: 12px;
            margin-bottom: 18px;
            box-shadow: 0 1px 6px rgba(0,0,0,0.05);
        }
        .mini-indicador, .final-indicador, .global-indicador {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: #888;
        }
        .mini-indicador {
            width: 2px;
            height: 12px;
        }
        .final-indicador, .global-indicador {
            width: 3px;
            height: 24px;
            background: #444;
        }
        .mini-valor, .final-valor {
            position: absolute;
            top: 0;
            height: 100%;
            background-color: inherit;
            max-width: 50%;
        }
        .global-valor {
            position: absolute;
            top: 0;
            height: 100%;
            background-color: inherit;
            border-radius: 12px;
        }
        .divider {
            border: none;
            border-top: 1px solid #e0e0e0;
            margin: 14px 0 16px 0;
        }
        .actualmente {
            font-size: 1.15rem;
            letter-spacing: 1px;
            color: #3b3b3b;
            font-weight: bold;
            margin: 8px 0 14px 0;
            text-align: center;
            line-height: 1.4;
        }
        .final-section, .global-section {
            font-size: 1.15rem;
            margin-bottom: 8px;
            color: #222;
            font-weight: 500;
        }
        .subcomentario {
            font-size: 0.92rem;
            font-style: italic;
            color: #555;
            font-weight: 400;
        }
        .separador {
            margin: 0 5px;
            color: #999;
        }
        .igual {
            margin: 0 5px;
            color: #555;
        }
        .valor-rojo {
            color: #d10000 !important;
            font-weight: bold;
        }
        .valor-verde {
            color: #008000 !important;
            font-weight: bold;
        }
        .disclaimer {
            margin: 25px auto 5px auto;
            max-width: 100%;
            color: #666;
            font-size: 0.95rem;
            background: #f8f8f8;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 1px 6px rgba(0,0,0,0.02);
        }
        .meta {
            max-width: 100%;
            margin: 0 auto 15px auto;
            color: #444;
            font-size: 0.96rem;
            text-align: center;
        }
        .riesgo-bajo {
            background-color: #008000 !important;
        }
        .riesgo-alto {
            background-color: #d10000 !important;
        }
        .riesgo-muy-alto {
            background-color: #b00000 !important;
        }
        .riesgo-maximo {
            background-color: #800000 !important;
        }
        .texto-riesgo-bajo {
            color: #008000 !important;
        }
        .texto-riesgo-alto {
            color: #d10000 !important;
        }
        .texto-riesgo-muy-alto {
            color: #b00000 !important;
        }
        .texto-riesgo-maximo {
            color: #800000 !important;
            font-weight: bold !important;
        }
        .alerta-maxima-texto {
            text-align: right;
            font-size: 0.8rem;
            color: #800000;
            font-weight: bold;
            margin-top: -15px;
            margin-bottom: 10px;
            padding-right: 15px;
        }
        .resumen-comentado {
            background: #333;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px auto;
            max-width: 900px;
            text-align: center;
            font-size: 0.95rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .resumen-titulo {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1rem;
            text-align: center;
            color: #fff;
        }
        .error-api {
            color: #d10000;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        .advertencia {
            background-color: #FFF8E1;
            color: #000;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 15px auto;
            max-width: 900px;
            text-align: center;
            font-weight: normal;
            box-shadow: 0 1px 6px rgba(0,0,0,0.05);
        }
        @media (max-width: 600px) {
            h2 {
                font-size: 1.5rem;
            }
            .final-section, .global-section {
                font-size: 1.05rem;
            }
            .subcomentario {
                font-size: 0.85rem;
            }
            .antigua, .actual, .riesgo-global {
                padding-left: 12px;
                padding-right: 12px;
            }
            .alerta-maxima-texto {
                font-size: 0.7rem;
                margin-top: -10px;
            }
            .resumen-comentado {
                padding: 12px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <h2>Informe de Riesgo vs Optimismo de Mercado</h2>
    <div class="subtitulo">actualizado cada 2 horas</div>
    <div class="espacio-linea"></div>
    
    <div class="container">
      <div class="antigua">
        <div class="contexto">RETROSPECTIVA, CONTEXTO DE 'EL MERCADO'</div>
        
        <div class="mini-section" id="mes-actual-texto">= Cargando datos...</div>
        <div class="mini-barra" id="mes-actual-barra">
            <div class="mini-indicador"></div>
            <div class="mini-valor" id="mes-actual-valor"></div>
        </div>
        
        <div class="mini-section" id="ultimos-3-meses-texto">= Cargando datos...</div>
        <div class="mini-barra" id="ultimos-3-meses-barra">
            <div class="mini-indicador"></div>
            <div class="mini-valor" id="ultimos-3-meses-valor"></div>
        </div>
        
        <div class="mini-section" id="ano-actual-texto">= Cargando datos...</div>
        <div class="mini-barra" id="ano-actual-barra">
            <div class="mini-indicador"></div>
            <div class="mini-valor" id="ano-actual-valor"></div>
        </div>
        
        <hr class="divider" />
        
        <div class="media-section" id="media-texto">= Cargando datos...</div>
        <div class="mini-barra" id="media-barra">
            <div class="mini-indicador"></div>
            <div class="mini-valor" id="media-valor"></div>
        </div>
      </div>
      
      <div class="actual">
        <div class="actualmente">CORTO PLAZO (días o pocas semanas) | Muestran el valor de previsión general y en los dos primeros apartados también incluye el valor Intradía (<i>letra cursiva</i>), todo actualizado cada 2 horas</div>
        
        <div class="final-section" id="riesgo-bolsa-texto">Cargando datos...</div>
        <div class="final-barra" id="riesgo-bolsa-barra">
            <div class="final-indicador"></div>
            <div class="final-valor" id="riesgo-bolsa-valor"></div>
        </div>
        
        <div class="final-section" id="riesgo-bitcoin-texto">Cargando datos...</div>
        <div class="final-barra" id="riesgo-bitcoin-barra">
            <div class="final-indicador"></div>
            <div class="final-valor" id="riesgo-bitcoin-valor"></div>
        </div>
        
        <div class="final-section" id="riesgo-bonos-texto">Cargando datos...</div>
        <div class="final-barra" id="riesgo-bonos-barra">
            <div class="final-indicador"></div>
            <div class="final-valor" id="riesgo-bonos-valor"></div>
        </div>
      </div>
      
      <div class="riesgo-global">
        <div class="global-section" id="riesgo-global-texto">Cargando datos...</div>
        <div class="global-barra" id="riesgo-global-barra">
            <div class="global-indicador" style="display: none;"></div>
            <div class="global-valor" id="riesgo-global-valor"></div>
        </div>
        <div class="alerta-maxima-texto">Valor de MÁXIMA ALERTA >= 84%</div>
      </div>
    </div>
    
    <div class="resumen-comentado" id="resumen-comentado">
        <div class="resumen-titulo">RESUMEN COMENTADO</div>
        <div id="resumen-contenido">Analizando los datos del mercado...</div>
    </div>
    
    <div class="advertencia">
        ADVERTENCIA IMPORTANTE: Estos indicadores funcionan de lunes a viernes, excepto los relacionados con Bitcoin que también se actualizan durante los fines de semana.
    </div>
    <div class="disclaimer">
        <b>Descargo de responsabilidad:</b> No es ninguna recomendación de inversión ni trading, es tan sólo educativo y para valoración experimental sobre previsión de mercado.
    </div>
    
    <div class="meta" id="meta-info"></div>

    <script>
        // ========== FUNCIÓN NUEVA: VARIACIÓN DIARIA DE GBP/JPY (24h) ========== //
        async function obtenerIntradiaGBPJPY() {
            try {
                const ahora = new Date();
                const ayer = new Date(ahora.getTime() - 24 * 60 * 60 * 1000);
                
                const [precioAyer, precioHoy] = await Promise.all([
                    fetch(`https://api.frankfurter.app/${ayer.toISOString().slice(0, 10)}?from=GBP&to=JPY`),
                    fetch(`https://api.frankfurter.app/latest?from=GBP&to=JPY`)
                ]);
                
                if (!precioAyer.ok || !precioHoy.ok) throw new Error("Error en API Frankfurter");
                
                const dataAyer = await precioAyer.json();
                const dataHoy = await precioHoy.json();
                
                if (!dataAyer.rates?.JPY || !dataHoy.rates?.JPY) {
                    throw new Error("Datos de GBP/JPY incompletos");
                }
                
                return ((dataHoy.rates.JPY - dataAyer.rates.JPY) / dataAyer.rates.JPY) * 100;
            } catch (error) {
                console.error("Error en obtenerIntradiaGBPJPY:", error);
                return NaN;
            }
        }

        // ========== FUNCIONES ORIGINALES (CON AJUSTES) ========== //
        async function obtenerAcumulado(from, to, fechaInicio, fechaFin) {
            try {
                const responseInicio = await fetch(`https://api.frankfurter.app/${fechaInicio.toISOString().slice(0, 10)}?from=${from}&to=${to}`);
                if (!responseInicio.ok) throw new Error("Error en API Frankfurter (inicio)");
                const dataInicio = await responseInicio.json();
                const valorInicio = dataInicio.rates[to];

                const responseFin = await fetch(`https://api.frankfurter.app/${fechaFin.toISOString().slice(0, 10)}?from=${from}&to=${to}`);
                if (!responseFin.ok) throw new Error("Error en API Frankfurter (fin)");
                const dataFin = await responseFin.json();
                const valorFin = dataFin.rates[to];

                return ((valorFin - valorInicio) / valorInicio) * 100;
            } catch (error) {
                console.error(`Error en obtenerAcumulado(${from}/${to}):`, error);
                return NaN;
            }
        }

        async function obtenerIntradiaBCHUSD() {
            try {
                const res = await fetch('https://api.coingecko.com/api/v3/coins/bitcoin-cash/market_chart?vs_currency=usd&days=2');
                if (!res.ok) throw new Error("Error en API CoinGecko");
                const data = await res.json();
                const precios = data.prices;
                
                const ahora = new Date().getTime();
                const hace24h = ahora - (24 * 60 * 60 * 1000);
                
                let precioAyer = precios[0][1];
                let precioHoy = precios[precios.length - 1][1];
                
                for (let i = 0; i < precios.length; i++) {
                    if (Math.abs(precios[i][0] - hace24h) < (12 * 60 * 60 * 1000)) {
                        precioAyer = precios[i][1];
                        break;
                    }
                }
                
                return ((precioHoy - precioAyer) / precioAyer) * 100;
            } catch (error) {
                console.error("Error en obtenerIntradiaBCHUSD:", error);
                return NaN;
            }
        }

        function getColorBarra(valor) {
            return valor < 0 ? "#d10000" : "#008000";
        }

        function getClaseColor(valor) {
            return valor < 0 ? "valor-rojo" : "valor-verde";
        }

        function getComentarioVariable1(acumulado) {
            if (isNaN(acumulado)) return "Datos no disponibles";
            if (acumulado < 0) {
                return "MALO para Bolsa y Bitcoin";
            } else if (acumulado > 0) {
                return "BUENO para Bolsa y Bitcoin";
            } else {
                return "Sin señal clara";
            }
        }

        function getComentarioBolsa(acumulado) {
            if (isNaN(acumulado)) return "Datos no disponibles";
            if (acumulado < 0) {
                return "MALO para Bolsa";
            } else if (acumulado > 0) {
                return "BUENO para Bolsa";
            } else {
                return "Sin señal clara";
            }
        }

        function getComentarioRefugio(valorReal) {
            if (isNaN(valorReal)) return "Datos no disponibles";
            if (valorReal < 0) {
                return "Favorable para Bonos y Dólar";
            } else if (valorReal > 0) {
                return "MALO para Bonos y Dólar";
            } else {
                return "Sin señal clara";
            }
        }

        function getComentarioBitcoin(valor) {
            if (isNaN(valor)) return "";
            if (valor < 0) return "MALO para Bitcoin";
            if (valor > 0) return "BUENO para Bitcoin";
            return "Sin señal clara";
        }

        function formatoFechaCEST(date) {
            const opciones = {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                hour12: false, timeZone: 'Europe/Madrid'
            };
            return date.toLocaleString('es-ES', opciones) + ' CEST';
        }

        function formatoHoraProxima(date) {
            const next = new Date(date.getTime() + 2 * 60 * 60 * 1000); // 2 horas
            const opciones = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'Europe/Madrid' };
            return next.toLocaleString('es-ES', opciones) + ' CEST';
        }

        function generarResumenComentado(media, riesgoBolsa, riesgoBitcoin, riesgoBonos, riesgoGlobal) {
            const resumen = document.getElementById('resumen-contenido');
            let textoResumen = "";
            
            if (isNaN(media) || isNaN(riesgoGlobal)) {
                textoResumen = "NO HAY DATOS PARA ACTUALIZAR, SE DEBE ESPERAR LA PRÓXIMA ACTUALIZACIÓN";
            } else {
                if (media < 0) {
                    textoResumen = "<b>El Mercado no es nada Optimista</b> y predomina el Valor Refugio. ";
                    textoResumen += "Se prevén ventas en los activos convencionales (excepto en Bonos) y posibilidad de aumento del precio del Dólar. ";
                } else if (media > 0) {
                    textoResumen = "<b>El Mercado muestra signos de Optimismo</b>. ";
                    textoResumen += "Se prevén compras en activos de riesgo como acciones y Bitcoin, con posible disminución en la demanda de activos refugio. ";
                } else {
                    textoResumen = "<b>El Mercado no muestra una tendencia clara</b>. ";
                    textoResumen += "Se recomienda cautela y diversificación de inversiones. ";
                }
                
                if (!isNaN(riesgoBonos)) {
                    if (riesgoBonos > 0) {
                        textoResumen += "<b>Los Bonos</b> muestran fuerte demanda como activo refugio, siendo propicio para compras según los indicadores actuales. ";
                        textoResumen += "<b>El Dólar</b> también aparece como activo refugio atractivo en el contexto actual. ";
                    } else if (riesgoBonos < 0) {
                        textoResumen += "<b>Los Bonos</b> muestran poca demanda según los indicadores, no siendo propicio para compras en el contexto actual. ";
                    }
                }
                
                if (riesgoGlobal >= 84) {
                    textoResumen += "<b>ALERTA MÁXIMA:</b> El riesgo global está en niveles críticos, lo que podría indicar turbulencias en los mercados financieros. ";
                } else if (riesgoGlobal >= 69) {
                    textoResumen += "<b>ALERTA:</b> El riesgo global es muy alto, sugiriendo precaución en las inversiones. ";
                } else if (riesgoGlobal >= 35) {
                    textoResumen += "El riesgo global es moderado-alto, con algunas señales de advertencia a considerar. ";
                } else {
                    textoResumen += "El riesgo global es bajo, indicando un entorno de mercado más estable y predecible. ";
                }
                
                if (media < 0 && riesgoGlobal > 69) {
                    textoResumen += "En el escenario actual, se recomienda enfoque defensivo con mayor peso en activos refugio.";
                } else if (media > 0 && riesgoGlobal < 35) {
                    textoResumen += "En el escenario actual, podría considerarse aumentar exposición a activos de riesgo con gestión adecuada.";
                } else {
                    textoResumen += "Se recomienda analizar cada activo individualmente, diversificar y mantener posiciones equilibradas.";
                }
            }
            
            resumen.innerHTML = textoResumen;
        }

        async function actualizarDatos() {
            const hoy = new Date();
            const año = hoy.getFullYear();
            const mes = hoy.getMonth() + 1;

            const fechaInicioMes = new Date(año, mes - 1, 1);
            const fechaInicio3Meses = new Date(año, mes - 4, 1);
            const fechaInicioAño = new Date(año, 0, 1);

            document.getElementById('mes-actual-texto').textContent = "= Obteniendo datos...";
            document.getElementById('ultimos-3-meses-texto').textContent = "= Obteniendo datos...";
            document.getElementById('ano-actual-texto').textContent = "= Obteniendo datos...";
            document.getElementById('media-texto').textContent = "= Obteniendo datos...";
            document.getElementById('riesgo-bolsa-texto').textContent = "Obteniendo datos...";
            document.getElementById('riesgo-bitcoin-texto').textContent = "Obteniendo datos...";
            document.getElementById('riesgo-bonos-texto').textContent = "Obteniendo datos...";
            document.getElementById('riesgo-global-texto').textContent = "Obteniendo datos...";

            try {
                const [variable1Mes, variable1TresMeses, variable1Ano] = await Promise.all([
                    obtenerAcumulado('USD', 'JPY', fechaInicioMes, hoy),
                    obtenerAcumulado('USD', 'JPY', fechaInicio3Meses, hoy),
                    obtenerAcumulado('USD', 'JPY', fechaInicioAño, hoy)
                ]);
                
                const [intradiaGBPJPY, acumuladoGBPJPY, acumuladoUSDJPY, intradiaB] = await Promise.all([
                    obtenerIntradiaGBPJPY(),
                    obtenerAcumulado('GBP', 'JPY', fechaInicioAño, hoy),
                    obtenerAcumulado('USD', 'JPY', fechaInicioAño, hoy),
                    obtenerIntradiaBCHUSD()
                ]);

                const variables = [variable1Mes, variable1TresMeses, variable1Ano];
                const maximo = 12;
                const barraWidth = 100;

                variables.forEach((acumulado, index) => {
                    const texto = document.getElementById(['mes-actual-texto', 'ultimos-3-meses-texto', 'ano-actual-texto'][index]);
                    const textos = [
                        'Mes actual (cálculo de nuestro propio indicador):',
                        'Últimos 3 meses (cálculo de nuestro propio indicador):',
                        'Año actual/acumulado (cálculo de nuestro propio indicador):'
                    ];
                    texto.innerHTML = isNaN(acumulado)
                        ? "= NO HAY DATOS PARA ACTUALIZAR, SE DEBE ESPERAR LA PRÓXIMA ACTUALIZACIÓN"
                        : `${textos[index]} <b class="${getClaseColor(acumulado)}">${acumulado.toFixed(2)}%</b> <span style="font-weight:400">${getComentarioVariable1(acumulado)}</span>`;
                    
                    const valor = document.getElementById(['mes-actual-valor', 'ultimos-3-meses-valor', 'ano-actual-valor'][index]);
                    const width = isNaN(acumulado) ? 0 : Math.min(Math.abs(acumulado) / (maximo * 3) * barraWidth, 50);
                    valor.style.width = `${width}%`;
                    valor.style.background = getColorBarra(acumulado);
                    if (acumulado < 0) {
                        valor.style.left = `calc(50% - ${width}%)`;
                    } else {
                        valor.style.left = "50%";
                    }
                });

                const media = variables.reduce((a, b) => a + b, 0) / variables.length;
                const textoMedia = document.getElementById('media-texto');
                textoMedia.innerHTML = isNaN(media)
                    ? "NO HAY DATOS PARA ACTUALIZAR, SE DEBE ESPERAR LA PRÓXIMA ACTUALIZACIÓN"
                    : `Media (cálculo de nuestro propio indicador): <b class="${getClaseColor(media)}">${media.toFixed(2)}%</b> <span style="font-weight:400">${getComentarioVariable1(media)}</span>`;
                
                const valorMedia = document.getElementById('media-valor');
                const widthMedia = isNaN(media) ? 0 : Math.min(Math.abs(media) / (maximo * 3) * barraWidth, 50);
                valorMedia.style.width = `${widthMedia}%`;
                valorMedia.style.background = getColorBarra(media);
                if (media < 0) {
                    valorMedia.style.left = `calc(50% - ${widthMedia}%)`;
                } else {
                    valorMedia.style.left = "50%";
                }

                // ===== SECCIÓN MODIFICADA: "Bolsa (actualizado)" con variación diaria (24h) ===== //
                const riesgoBolsa = (isNaN(media) ? 0 : media) + (isNaN(intradiaGBPJPY) ? 0 : intradiaGBPJPY);
                const textoRiesgoBolsa = document.getElementById('riesgo-bolsa-texto');
                textoRiesgoBolsa.innerHTML = isNaN(riesgoBolsa)
                    ? "NO HAY DATOS PARA ACTUALIZAR, SE DEBE ESPERAR LA PRÓXIMA ACTUALIZACIÓN"
                    : `Bolsa (actualizado): <b class="${getClaseColor(riesgoBolsa)}">${riesgoBolsa.toFixed(2)}%</b> <span class="subcomentario"><span class="separador">|</span> Intradía Bolsa: ${isNaN(intradiaGBPJPY) ? 'ND' : intradiaGBPJPY.toFixed(2)}% <span class="igual">=</span> ${getComentarioBolsa(intradiaGBPJPY)} para las próximas horas.</span>`;
                
                const valorRiesgoBolsa = document.getElementById('riesgo-bolsa-valor');
                const widthRiesgoBolsa = isNaN(riesgoBolsa) ? 0 : Math.min(Math.abs(riesgoBolsa) / (maximo * 3) * barraWidth, 50);
                valorRiesgoBolsa.style.width = `${widthRiesgoBolsa}%`;
                valorRiesgoBolsa.style.background = getColorBarra(riesgoBolsa);
                if (riesgoBolsa < 0) {
                    valorRiesgoBolsa.style.left = `calc(50% - ${widthRiesgoBolsa}%)`;
                } else {
                    valorRiesgoBolsa.style.left = "50%";
                }

                let intradiaB_ajustado = intradiaB;
                if (!isNaN(intradiaB)) {
                    if (intradiaB > 0) intradiaB_ajustado = intradiaB / 3;
                    else if (intradiaB < 0) intradiaB_ajustado = intradiaB / 2;
                }
                
                const riesgoBitcoin = (isNaN(media) ? 0 : media) + (isNaN(intradiaB_ajustado) ? 0 : intradiaB_ajustado);
                const textoRiesgoBitcoin = document.getElementById('riesgo-bitcoin-texto');
                textoRiesgoBitcoin.innerHTML = isNaN(riesgoBitcoin)
                    ? "NO HAY DATOS PARA ACTUALIZAR, SE DEBE ESPERAR LA PRÓXIMA ACTUALIZACIÓN"
                    : `Bitcoin (actualizado): <b class="${getClaseColor(riesgoBitcoin)}">${riesgoBitcoin.toFixed(2)}%</b> <span class="subcomentario"><span class="separador">|</span> Intradía Bitcoin: ${isNaN(intradiaB) ? 'ND' : intradiaB.toFixed(2)}% <span class="igual">=</span> ${getComentarioBitcoin(intradiaB)} para las próximas horas.</span>`;
                
                const valorRiesgoBitcoin = document.getElementById('riesgo-bitcoin-valor');
                const widthRiesgoBitcoin = isNaN(riesgoBitcoin) ? 0 : Math.min(Math.abs(riesgoBitcoin) / (maximo * 3) * barraWidth, 50);
                valorRiesgoBitcoin.style.width = `${widthRiesgoBitcoin}%`;
                valorRiesgoBitcoin.style.background = getColorBarra(riesgoBitcoin);
                if (riesgoBitcoin < 0) {
                    valorRiesgoBitcoin.style.left = `calc(50% - ${widthRiesgoBitcoin}%)`;
                } else {
                    valorRiesgoBitcoin.style.left = "50%";
                }

                const valorRefugioReal = -media;
                const valorRefugioMostrar = Math.abs(valorRefugioReal);
                const esRefugioPositivo = valorRefugioReal > 0;
                const colorRefugio = esRefugioPositivo ? "#008000" : "#d10000";
                const claseColorRefugio = esRefugioPositivo ? "valor-verde" : "valor-rojo";
                
                const textoRiesgoBonos = document.getElementById('riesgo-bonos-texto');
                textoRiesgoBonos.innerHTML = isNaN(valorRefugioMostrar)
                    ? "NO HAY DATOS PARA ACTUALIZAR, SE DEBE ESPERAR LA PRÓXIMA ACTUALIZACIÓN"
                    : `Bonos y otros activos Refugio: <b class="${claseColorRefugio}">${'+' + valorRefugioMostrar.toFixed(2)}%</b> <span class="igual">=</span> <span style="font-weight:400">${getComentarioRefugio(media)}</span>`;
                
                const valorRiesgoBonos = document.getElementById('riesgo-bonos-valor');
                const widthRiesgoBonos = isNaN(valorRefugioMostrar) ? 0 : Math.min(valorRefugioMostrar / (maximo * 3) * barraWidth, 50);
                valorRiesgoBonos.style.width = `${widthRiesgoBonos}%`;
                valorRiesgoBonos.style.background = colorRefugio;
                if (esRefugioPositivo) {
                    valorRiesgoBonos.style.left = "50%";
                } else {
                    valorRiesgoBonos.style.left = `calc(50% - ${widthRiesgoBonos}%)`;
                }

                // ===== RIESGO GLOBAL (se mantiene igual, usa acumuladoGBPJPY anual) ===== //
                const riesgoGlobal = Math.abs(((isNaN(acumuladoGBPJPY) ? 0 : acumuladoGBPJPY) + (isNaN(acumuladoUSDJPY) ? 0 : acumuladoUSDJPY)) * 10);

                let nivelRiesgo = "";
                let claseColor = "";
                let claseTexto = "";
                let widthPercentage = 0;

                if (riesgoGlobal <= 35) {
                    nivelRiesgo = "Riesgo bajo (óptimo)";
                    claseColor = "riesgo-bajo";
                    claseTexto = "texto-riesgo-bajo";
                    widthPercentage = Math.max((riesgoGlobal / 35) * 25, 5);
                } else if (riesgoGlobal > 35 && riesgoGlobal < 69) {
                    nivelRiesgo = "Riesgo alto (peligro)";
                    claseColor = "riesgo-alto";
                    claseTexto = "texto-riesgo-alto";
                    widthPercentage = 25 + ((riesgoGlobal - 35) / (69 - 35)) * 35;
                } else if (riesgoGlobal >= 69 && riesgoGlobal < 84) {
                    nivelRiesgo = "Riesgo Muy Alto (Alerta)";
                    claseColor = "riesgo-muy-alto";
                    claseTexto = "texto-riesgo-muy-alto";
                    widthPercentage = 60 + ((riesgoGlobal - 69) / (84 - 69)) * 25;
                } else {
                    nivelRiesgo = "ALTO RIESGO (ALERTA MÁXIMA)";
                    claseColor = "riesgo-maximo";
                    claseTexto = "texto-riesgo-maximo";
                    widthPercentage = Math.min(85 + ((riesgoGlobal - 84) / 20) * 15, 100);
                }

                const textoRiesgoGlobal = document.getElementById('riesgo-global-texto');
                const valorRiesgoGlobal = document.getElementById('riesgo-global-valor');
                
                textoRiesgoGlobal.innerHTML = isNaN(riesgoGlobal)
                    ? "NO HAY DATOS PARA ACTUALIZAR, SE DEBE ESPERAR LA PRÓXIMA ACTUALIZACIÓN"
                    : `Riesgo Global - Económico & Geopolítico: <b class="${claseTexto}">${riesgoGlobal.toFixed(2)}%</b> <span style="font-weight:400">${nivelRiesgo}</span>`;
                
                valorRiesgoGlobal.style.width = `${widthPercentage}%`;
                valorRiesgoGlobal.className = "global-valor " + claseColor;
                valorRiesgoGlobal.style.left = "0%";
                
                generarResumenComentado(media, riesgoBolsa, riesgoBitcoin, valorRefugioReal, riesgoGlobal);
            } catch (error) {
                console.error("Error general al actualizar datos:", error);
                document.getElementById('mes-actual-texto').innerHTML = "= NO HAY DATOS PARA ACTUALIZAR, SE DEBE ESPERAR LA PRÓXIMA ACTUALIZACIÓN";
                document.getElementById('ultimos-3-meses-texto').innerHTML = "= NO HAY DATOS PARA ACTUALIZAR, SE DEBE ESPERAR LA PRÓXIMA ACTUALIZACIÓN";
                document.getElementById('ano-actual-texto').innerHTML = "= NO HAY DATOS PARA ACTUALIZAR, SE DEBE ESPERAR LA PRÓXIMA ACTUALIZACIÓN";
                document.getElementById('media-texto').innerHTML = "= NO HAY DATOS PARA ACTUALIZAR, SE DEBE ESPERAR LA PRÓXIMA ACTUALIZACIÓN";
                document.getElementById('riesgo-bolsa-texto').innerHTML = "NO HAY DATOS PARA ACTUALIZAR, SE DEBE ESPERAR LA PRÓXIMA ACTUALIZACIÓN";
                document.getElementById('riesgo-bitcoin-texto').innerHTML = "NO HAY DATOS PARA ACTUALIZAR, SE DEBE ESPERAR LA PRÓXIMA ACTUALIZACIÓN";
                document.getElementById('riesgo-bonos-texto').innerHTML = "NO HAY DATOS PARA ACTUALIZAR, SE DEBE ESPERAR LA PRÓXIMA ACTUALIZACIÓN";
                document.getElementById('riesgo-global-texto').innerHTML = "NO HAY DATOS PARA ACTUALIZAR, SE DEBE ESPERAR LA PRÓXIMA ACTUALIZACIÓN";
                document.getElementById('resumen-contenido').innerHTML = "NO HAY DATOS PARA ACTUALIZAR, SE DEBE ESPERAR LA PRÓXIMA ACTUALIZACIÓN";
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-api';
                errorDiv.textContent = 'NO HAY DATOS PARA ACTUALIZAR, SE DEBE ESPERAR LA PRÓXIMA ACTUALIZACIÓN';
                document.querySelector('.container').prepend(errorDiv);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            actualizarDatos();
            actualizarMeta();
        });
        setInterval(actualizarDatos, 2 * 60 * 60 * 1000); // 2 horas

        function actualizarMeta() {
            const ahora = new Date();
            let texto = `Actualizado: <b>${formatoFechaCEST(ahora)}</b><br>
            Próxima actualización: <b>${formatoHoraProxima(ahora)}</b> (actualiza cada 2 horas)<br>
            Autores: <b>Tom Lips & VipTrader</b>`;
            document.getElementById('meta-info').innerHTML = texto;
        }

        setInterval(actualizarMeta, 2 * 60 * 60 * 1000); // 2 horas
    </script>
</body>
</html>
